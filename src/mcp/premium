app.post("/mcp/premium", async (req: Request, res: Response) => {
  if (!(await requirePayment(req, res, PRICE_PREMIUM))) return;

  const { tool, diff, threshold } = req.body;
  if (!tool || !diff) return res.status(400).json({ error: "Missing required fields: tool, diff" });

  switch (tool) {
    case "review_diff":
      return res.json({ tool: "review_diff", tier: "premium", ...reviewDiff(diff) });
    case "pipeline_guard":
      return res.json({ tool: "pipeline_guard", tier: "premium", ...pipelineGuard(diff, threshold ?? 50) });
    case "generate_fix_patch": {
      const fixes = generateFixSuggestions(diff);
      const review = reviewDiff(diff);
      return res.json({ tool: "generate_fix_patch", tier: "premium", decision: review.decision, score: review.score, fixes });
    }
    default:
      return res.status(400).json({ error: `Unknown premium tool: ${tool}. Available: review_diff, pipeline_guard, generate_fix_patch` });
  }
});
